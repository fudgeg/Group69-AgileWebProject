{% extends "base.html" %} {% block title %}For You – Soul Maps{% endblock %} {%
block content %}
<div class="home-container">
  <h2>For You</h2>

  <div class="content">
    <div class="recommended-section">
      <h3>Recommended Media Maps</h3>
      <ul>
        <li><b>Dark Matter</b> — trending sci-fi show map</li>
        <li><b>Mistborn</b> — epic fantasy book journey</li>
        <li>
          <b>Everything Everywhere All At Once</b> — multiverse madness movie
          map
        </li>
      </ul>
    </div>

    <div class="brain-image">
      <img 
      src="{{ url_for('static', filename='media/brainNetwork.png') }}" 
      alt="Brain Network"
      />
    </div>

    <div class="trending-section">
      <h3>Trending in Your Network</h3>
      <ul>
        <li><b>Bob</b> recommends <i>The Three-Body Problem</i></li>
        <li><b>Alice</b> is loving <i>Severance</i></li>
        <li><b>Charlie</b> just finished <i>The Sandman</i></li>
      </ul>
    </div>

    <div class="discover-section">
      <h3 class="text-center">Media Type Breakdown</h3>

      <!-- Main Pie Chart -->
      <canvas id="mediaChart" width="400" height="400" class="d-block mx-auto"></canvas>

      <!-- Embed media type counts as JSON for Chart.js to render the main pie chart -->
      <div id="media-data" data-json='{{ media_counts | tojson | safe }}' style="display: none;"></div>

      <!-- Mini Genre Chart -->
      <div id="mini-chart-container" class="text-center mt-5" style="display: none;">
        <h5 id="mini-chart-title"></h5>
        <canvas id="miniChart" width="300" height="300" class="d-block mx-auto"></canvas>
      </div>

      <!-- Embed genre breakdowns per media type as JSON for generating mini charts on user interaction -->
      <div id="genre-breakdowns" data-json='{{ genre_breakdowns | tojson | safe }}' style="display: none;"></div>

      <!-- Load Chart.js library for rendering visual analytics (media breakdown & genre charts) -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const mediaData = JSON.parse(document.getElementById("media-data").dataset.json);
        const genreBreakdowns = JSON.parse(document.getElementById("genre-breakdowns").dataset.json);
        let miniChart = null;

        const ctxMain = document.getElementById("mediaChart").getContext("2d");
        const mainChart = new Chart(ctxMain, {
          type: 'pie',
          data: {
            labels: Object.keys(mediaData),
            datasets: [{
              data: Object.values(mediaData),
              backgroundColor: [
                "rgba(255, 99, 132, 0.6)",   // Books colour
                "rgba(54, 162, 235, 0.6)",   // Movies colour
                "rgba(255, 206, 86, 0.6)",   // TV Shows colour
                "rgba(75, 192, 192, 0.6)"    // Music colour
              ],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: false }
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const mediaType = mainChart.data.labels[index];
                const genreData = genreBreakdowns[mediaType];

                if (!genreData || Object.keys(genreData).length === 0) return;

                const miniCtx = document.getElementById("miniChart").getContext("2d");
                if (miniChart) miniChart.destroy();

                document.getElementById("mini-chart-title").textContent = `Genres in ${mediaType}`;
                document.getElementById("mini-chart-container").style.display = "block";

                miniChart = new Chart(miniCtx, {
                  type: 'bar',
                  data: {
                    labels: Object.keys(genreData),
                    datasets: [{
                      label: 'Genre Count',
                      data: Object.values(genreData),
                      backgroundColor: "rgba(54, 162, 235, 0.6)",
                      borderColor: "rgba(54, 162, 235, 1)",
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    indexAxis: 'x',  //  makes it vertical
                    scales: {
                      x: {
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: 'Entries'
                        }
                      },
                      y: {
                        title: {
                          display: true,
                          text: 'Genres'
                        }
                      }
                    },
                    plugins: {
                      legend: { display: false },
                      title: {
                        display: false
                      }
                    }
                  }
                });

              }
            }
          }
        });
      </script>
    </div>

  </div>
</div>
{% endblock %}