{% extends "base.html" %} {% block title %}For You â€“ Soul Maps{% endblock %} {%
block content %}

<div class="for-you-page">
  <!-- Media Identity Title -->
  <div class="text-center">
    <h2 class="mb-4">{{ identity }}</h2>
  </div>

  <!-- Compact Media Counts in One Row -->
  <div class="d-flex flex-wrap justify-content-center gap-3 mb-5">
    <div class="media-card-small">
      <img
        src="{{ url_for('static', filename='media/books.png') }}"
        alt="Books"
        class="media-icon mb-2"
      />
      <div><strong>Books</strong></div>
      <div>{{ media_counts['Books'] }}</div>
    </div>
    <div class="media-card-small">
      <img
        src="{{ url_for('static', filename='media/movies.png') }}"
        alt="Movies"
        class="media-icon mb-2"
      />
      <div><strong>Movies</strong></div>
      <div>{{ media_counts['Movies'] }}</div>
    </div>
    <div class="media-card-small">
      <img
        src="{{ url_for('static', filename='media/tv.png') }}"
        alt="TV Shows"
        class="media-icon mb-2"
      />
      <div><strong>TV Shows</strong></div>
      <div>{{ media_counts['TV Shows'] }}</div>
    </div>
    <div class="media-card-small">
      <img
        src="{{ url_for('static', filename='media/music.png') }}"
        alt="Music"
        class="media-icon mb-2"
      />
      <div><strong>Music</strong></div>
      <div>{{ media_counts['Music'] }}</div>
    </div>
  </div>

  <!-- Section Title -->
  <h3 class="text-center mb-4">Top Genres</h3>

  <!-- One Chart per Media Type -->
  <div class="row justify-content-center text-center">
    {% for media_type, genres in genre_breakdowns.items() %} {% if genres %}
    <div class="col-12 col-md-6 col-lg-4 mb-5 d-flex justify-content-center">
      <div class="chart-container">
        <h5>{{ media_type }}</h5>
        <canvas id="{{ media_type | replace(' ', '_') }}_genre_chart"></canvas>
      </div>
    </div>
    {% endif %} {% endfor %}
  </div>

  <!-- Embed data as JSON directly -->
  <script>
    const genreData = {{ genre_breakdowns | tojson | safe }};
  </script>

  <!-- Chart.js libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Share Buttons -->
  <div class="text-center mb-5">
    <button class="btn btn-primary" onclick="shareToFriends()">
      Share to Friends
    </button>
    <button class="btn btn-secondary" onclick="shareToEmail()">
      Share via Email
    </button>
    <button class="btn btn-outline-dark" onclick="exportAsImage()">
      Export as Image
    </button>
  </div>

  <!-- JS to Render Pie Charts -->
  <script>
    const colors = [
      "#006633",
      "#4c9900",
      "#00994c",
      "#20540E",
      "#74EC48",
      "#8BC34A",
      "#AED581",
      "#DCEDC8",
    ];

    Object.entries(genreData).forEach(([mediaType, genres]) => {
      const canvasId = `${mediaType.replace(/ /g, "_")}_genre_chart`;
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(genres),
          datasets: [
            {
              data: Object.values(genres),
              backgroundColor: colors.slice(0, Object.keys(genres).length),
              borderColor: "#fff",
              borderWidth: 2,
            },
          ],
        },
        options: {
          plugins: {
            legend: { display: false },
            datalabels: {
              color: "#fff",
              font: {
                family: "Segoe UI",
                weight: "bold",
                size: 14,
              },
              formatter: (_, ctx) => ctx.chart.data.labels[ctx.dataIndex],
            },
          },
          responsive: true,
          maintainAspectRatio: true,
        },
        plugins: [ChartDataLabels],
      });
    });

    function shareToFriends() {
      alert("Friend sharing coming soon!"); // Placeholder for now
    }

    function shareToEmail() {
      const subject = "Check out my Media Stats on Soul Maps!";
      const body = `Hey, I just found out my media consumption profile on Soul Maps and I'm a ${identity}! Check out my top genres and more!`;

      const mailtoLink = `mailto:?subject=${encodeURIComponent(
        subject
      )}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
    }

    function exportAsImage() {
      const forYouPage = document.querySelector(".for-you-page");
      html2canvas(forYouPage).then((canvas) => {
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "SoulMaps_Snapshot.png";
        link.click();
      });
    }
  </script>
</div>

{% endblock %}
